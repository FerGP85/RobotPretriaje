<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pre-Triage | Kiosco (Captura + Cuestionario)</title>
<style>
  :root{
    /* Colores base modo oscuro */
    --bg: #020617;
    --bg-soft: #020617;
    --bg-elevated: #0b1120;
    --border-subtle: #1f2937;
    --fg: #e5e7eb;
    --muted: #9ca3af;

    /* Acentos */
    --accent: #38bdf8;
    --accent-soft: rgba(56, 189, 248, 0.12);

    /* Severidades */
    --ok:   #22c55e;
    --low:  #eab308;
    --mid:  #f97316;
    --high: #ef4444;
  }

  *{
    box-sizing:border-box;
    -webkit-tap-highlight-color: transparent;
  }

  html,body{
    height:100%;
    margin:0;
  }

  body{
    font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    display:flex;
    flex-direction:column;
    background:
      radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%);
    color:var(--fg);
  }

  /******** Header ********/

  header{
    padding:12px 18px;
    display:flex;
    gap:12px;
    align-items:center;
    border-bottom:1px solid var(--border-subtle);
    background:rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    border-radius:0 0 18px 18px;
  }

  header h1{
    font-size:18px;
    margin:0;
    flex:1;
    font-weight:600;
    letter-spacing:0.02em;
  }

  .dot{
    width:10px;
    height:10px;
    border-radius:50%;
    background:#4b5563;
    box-shadow:0 0 0 4px rgba(148,163,184,0.24);
  }
  .dot.ok{
    background:var(--ok);
    box-shadow:0 0 0 4px rgba(34,197,94,0.25);
  }
  .dot.bad{
    background:var(--high);
    box-shadow:0 0 0 4px rgba(239,68,68,0.25);
  }

  /******** Layout y tarjetas ********/

  main{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:16px;
    padding:16px;
  }

  .card{
    background:var(--bg-elevated);
    border:1px solid var(--border-subtle);
    border-radius:18px;
    box-shadow:
      0 18px 45px rgba(15, 23, 42, 0.8),
      0 0 0 1px rgba(15, 23, 42, 0.6);
    overflow:hidden;
    transition:
      transform 160ms ease-out,
      box-shadow 160ms ease-out,
      border-color 160ms ease-out,
      background-color 160ms ease-out;
  }

  .pane{
    padding:16px;
  }

  .card:hover{
    transform:translateY(-1px);
    border-color:rgba(148,163,184,0.4);
    box-shadow:
      0 22px 55px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(148,163,184,0.3);
  }

  .row{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
  }

  .col{
    flex:1;
    min-width:180px;
  }

  /******** Formularios ********/

  label{
    display:block;
    font-size:13px;
    color:var(--muted);
    margin-bottom:6px;
  }

  input,
  button{
    font-family:inherit;
    font-size:16px;
    padding:12px 14px;
    border-radius:12px;
    border:1px solid var(--border-subtle);
    width:100%;
    background:var(--bg-soft);
    color:var(--fg);
    outline:none;
    transition:
      border-color 140ms ease-out,
      background-color 140ms ease-out,
      box-shadow 140ms ease-out,
      transform 80ms ease-out;
  }

  input::placeholder{
    color:rgba(148,163,184,0.7);
  }

  input:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 1px rgba(56,189,248,0.65);
    background:#020617;
  }

  /******** Botones ********/

  button{
    cursor:pointer;
    background:var(--accent-soft);
    border-color:rgba(56,189,248,0.5);
    color:var(--fg);
    font-weight:500;
    letter-spacing:0.01em;
  }

  button:hover{
    background:rgba(56,189,248,0.18);
    box-shadow:0 0 0 1px rgba(56,189,248,0.65);
  }

  button:active{
    transform:scale(0.98);
    box-shadow:none;
  }

  .nav{
    display:flex;
    gap:12px;
    padding:12px 0 0;
  }

  .nav button{
    flex:1;
    font-size:16px;
    padding:14px;
    border-radius:14px;
  }

  .actions{
    display:flex;
    gap:12px;
    margin-top:12px;
  }

  .danger{
    background:rgba(239,68,68,0.14);
    border-color:rgba(239,68,68,0.6);
    color:#fecaca;
  }

  .danger:hover{
    background:rgba(239,68,68,0.22);
    box-shadow:0 0 0 1px rgba(239,68,68,0.7);
  }

  /******** Preguntas / layout principal ********/

  .question{
    text-align:center;
    padding:4px 12px 0;
  }

  .question h2{
    font-size:28px;
    margin:10px 0 14px;
    font-weight:600;
  }

  .grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    padding:12px 0;
  }

  .bigbtn{
    user-select:none;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:20px;
    font-size:40px;
    font-weight:800;
    height:34vh;
    border:1px solid rgba(148,163,184,0.4);
    background:radial-gradient(circle at top, #020617 0, #020617 60%, #000 100%);
    box-shadow:
      0 14px 30px rgba(15,23,42,0.9),
      0 0 0 1px rgba(15,23,42,0.7);
  }

  .bigbtn:hover{
    box-shadow:
      0 18px 40px rgba(15,23,42,1),
      0 0 0 1px rgba(148,163,184,0.6);
  }

  .yes{
    background:radial-gradient(circle at top, rgba(34,197,94,0.2), rgba(15,23,42,1));
    border-color:rgba(34,197,94,0.7);
    color:#bbf7d0;
  }

  .no{
    background:radial-gradient(circle at top, rgba(239,68,68,0.2), rgba(15,23,42,1));
    border-color:rgba(239,68,68,0.7);
    color:#fecaca;
  }

  /******** Etiquetas / textos ********/

  .pill{
    display:inline-block;
    padding:4px 12px;
    border-radius:999px;
    font-weight:600;
    color:#f9fafb;
    font-size:13px;
  }

  .sev-ok{
    background:var(--ok);
  }
  .sev-low{
    background:var(--low);
    color:#111827;
  }
  .sev-mid{
    background:var(--mid);
  }
  .sev-high{
    background:var(--high);
  }

  .muted{
    color:var(--muted);
    font-size:13px;
  }

  .center{
    text-align:center;
  }

  .hint{
    font-size:14px;
    color:var(--muted);
    margin:6px 0 0;
  }

  .kpi{
    font-size:22px;
    font-weight:600;
    margin-top:12px;
  }

  .small{
    font-size:12px;
    color:var(--muted);
  }

  #qrCanvas {
  width: 320px;
  height: 320px;
  margin: 0 auto 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background:#ffffff;
  border-radius:12px;
  border:1px solid #1f2937;
}

#qrCanvas canvas {
  image-rendering: pixelated;
}

  /******** Progress bars ********/

  progress{
    width:100%;
    height:10px;
    border-radius:999px;
    overflow:hidden;
    background:#020617;
    border:1px solid var(--border-subtle);
  }

  progress::-webkit-progress-bar{
    background:#020617;
  }
  progress::-webkit-progress-value{
    background:var(--accent);
  }
  progress::-moz-progress-bar{
    background:var(--accent);
  }

  /******** Responsivo ********/

  @media (max-width: 768px){
    header{
      padding:10px 14px;
    }
    header h1{
      font-size:16px;
    }
    main{
      padding:10px;
      gap:12px;
    }
    .pane{
      padding:12px;
    }
    .bigbtn{
      font-size:32px;
      height:30vh;
    }
  }
</style>

</head>
<body>
<header class="pane card">
  <div class="dot" id="dot" title="Estado WS"></div>
  <h1>Pre-Triage — Kiosco</h1>
  <div class="muted" id="wsurl"></div>
</header>

<main>
  <!-- 0) Datos del paciente -->
  <section id="setup" class="card pane">
    <div class="row">
      <div class="col">
        <label>Nombre del paciente</label>
        <input id="patient" placeholder="Nombre completo" autofocus />
      </div>
      <div class="col">
        <label>Quién registra (opcional)</label>
        <input id="operator" placeholder="Enfermero(a) / Operador" />
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div class="col">
        <label>Edad</label>
        <input id="age" type="number" min="0" max="120" placeholder="Años" />
      </div>
      <div class="col">
        <label>Estatura</label>
        <input id="height" type="number" min="80" max="230" placeholder="cm" />
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="col"><button id="goCapture">Continuar a captura</button></div>
    </div>
  </section>

  <!-- 1) Preparación Oxímetro -->
  <section id="prepHR" class="card pane" style="display:none;">
    <h2 class="center">Coloca el dedo en el <b>oxímetro</b></h2>
    <p class="center hint">La medición iniciará automáticamente.</p>
    <progress id="prepProgHR" max="100" value="0"></progress>
    <p class="center small">Preparación: <span id="prepSecHR">5</span> s</p>
  </section>

  <!-- 1b) Captura Oxímetro -->
  <section id="capHR" class="card pane" style="display:none;">
    <h2 class="center">Midiendo <b>oxímetro</b></h2>
    <progress id="progHR" max="100" value="0"></progress>
    <p class="kpi">HR: <span id="hrNow">--</span> bpm &nbsp;|&nbsp; SpO₂: <span id="spoNow">--</span>%</p>
    <p class="small" id="hrCount">Muestras válidas: 0</p>
    <div class="actions">
      <button id="retryHR">Reintentar</button>
      <button id="skipHR" class="danger">Omitir (continuar)</button>
    </div>
  </section>

  <!-- 2) Preparación Temperatura -->
  <section id="prepT" class="card pane" style="display:none;">
    <h2 class="center">Coloca el sensor de <b>temperatura</b> en contacto</h2>
    <p class="center hint">La medición iniciará automáticamente.</p>
    <progress id="prepProgT" max="100" value="0"></progress>
    <p class="center small">Preparación: <span id="prepSecT">5</span> s</p>
  </section>

  <!-- 2b) Captura Temperatura -->
  <section id="capT" class="card pane" style="display:none;">
    <h2 class="center">Midiendo <b>temperatura</b></h2>
    <progress id="progT" max="100" value="0"></progress>
    <p class="kpi">To: <span id="toNow">--</span> °C &nbsp;|&nbsp; Ta: <span id="taNow">--</span> °C</p>
    <p class="small" id="tCount">Muestras: 0</p>
    <div class="actions">
      <button id="retryT">Reintentar</button>
      <button id="skipT" class="danger">Omitir (continuar)</button>
    </div>
  </section>

  <!-- 2c) Preparación Peso -->
<section id="prepW" class="card pane" style="display:none;">
  <h2 class="center">Súbete a la <b>báscula</b></h2>
  <p class="center hint">Mantente quieto; la medición iniciará automáticamente.</p>
  <progress id="prepProgW" max="100" value="0"></progress>
  <p class="center small">Preparación: <span id="prepSecW">5</span> s</p>
</section>

<!-- 2d) Captura Peso -->
<section id="capW" class="card pane" style="display:none;">
  <h2 class="center">Midiendo <b>peso</b></h2>
  <progress id="progW" max="100" value="0"></progress>
  <p class="kpi">Peso: <span id="wNow">--</span> kg</p>
  <p class="small" id="wCount">Muestras: 0</p>
  <div class="actions">
    <button id="retryW">Reintentar</button>
    <button id="skipW" class="danger">Omitir (continuar)</button>
  </div>
</section>

  <!-- 3) Cuestionario -->
  <section id="quiz" class="card" style="display:none;">
    <div class="question">
      <div id="progress" class="muted">Pregunta 1/6</div>
      <h2 id="qtext">Pregunta</h2>
    </div>
    <div class="grid pane">
      <button class="bigbtn yes" id="btnYes">SÍ</button>
      <button class="bigbtn no"  id="btnNo">NO</button>
    </div>
    <div class="nav pane">
      <button id="back">⟵ Atrás</button>
      <button id="skip">Saltar</button>
      <button id="cancel" class="danger">Cancelar</button>
    </div>
  </section>

  <!-- 4) Resultado -->
  <section id="done" class="card pane" style="display:none;">
    <h2>Resultado</h2>
    <p id="resultText" style="font-size:18px;"></p>
    <div id="sevPill" class="pill sev-ok">No crítico</div>
    <div id="shareBox"
     style="margin-top:14px; display:flex; flex-direction:column;
            gap:12px; align-items:center; text-align:center;">

  <div id="qrCanvas"></div>

  <div>
    <div class="muted">Escanea este QR o abre el enlace:</div>
    <input id="shareLink" readonly style="margin-top:6px; width:100%; font-size:13px; padding:10px 12px; border-radius:10px;">
    <div class="actions">
      <button id="copyLink">Copiar enlace</button>
      <button id="downloadPNG">Descargar PNG</button>
    </div>
  </div>
</div>
    <p class="muted" id="raw"></p>
    <div class="row" style="margin-top:12px;">
      <div class="col"><button id="new">Nuevo paciente</button></div>
    </div>
  </section>
</main>

<script src="qrcode.min.js"></script>


<script>
/*** CONFIGURABLES (tiempos y mínimos) ***/
const WS_URL = "ws://10.25.82.235:1880/ws/pretriage";   // <-- AJUSTAR IP, DEBE SER LA MISMA EN KIOSK Y DASHBOARD
const PREP_HR_MS = 5000, CAP_HR_MS = 15000;      // 5 s prep + 15 s captura
const PREP_T_MS  = 5000, CAP_T_MS  = 15000;
const PREP_W_MS = 5000, CAP_W_MS = 15000;  // 5 s prep + 15 s captura para peso
const MIN_W_SAMPLES = 1;                    // mínimo de muestras de peso (ajusta)
const MAX_W_STD = 0.4;                      // Desviación máx. en kg para considerar estable
const MIN_HR_OK_SAMPLES = 1;   // mín. muestras HR válidas
const MIN_SPO_OK_SAMPLES = 1;  // mín. muestras SpO2 válidas
const MIN_T_SAMPLES = 1;      // mín. muestras To/Ta

/*** PREGUNTAS / SCORING ***/
const QUESTIONS = [
  // Bloque A: signos de alarma (pueden disparar ROJO directo)
  { id:"Q1", text:"¿Te falta el aire incluso estando sentado o en reposo?", yes:5, no:0, emergencyIfYes:true },
  { id:"Q2", text:"¿Sientes un dolor u opresión muy fuerte en el pecho que no se quita?", yes:5, no:0, emergencyIfYes:true },
  { id:"Q3", text:"¿Has tenido desmayos o pérdida de conciencia recientemente?", yes:5, no:0, emergencyIfYes:true },
  { id:"Q4", text:"¿Te notas muy confundido/a o con mucha dificultad para mantenerte despierto/a?", yes:5, no:0, emergencyIfYes:true },
  { id:"Q5", text:"¿Tus labios o dedos se ponen morados o azulados?", yes:6, no:0, emergencyIfYes:true },

  // Bloque B/C: síntomas y factores de riesgo
  { id:"Q6",  text:"¿Tienes síntomas (fiebre, tos, dolor) desde hace más de 3 días?", yes:2, no:0 },
  { id:"Q7",  text:"¿Tu dificultad para respirar ha empeorado con el tiempo?", yes:3, no:0 },
  { id:"Q8",  text:"¿Te cuesta mucho trabajo caminar dentro de la sala sin quedarte sin aire?", yes:3, no:0 },
  { id:"Q9",  text:"¿Tu dolor es intenso (7 a 10 en la escala del 0 al 10)?", yes:3, no:0 },
  { id:"Q10", text:"¿Tienes vómito tan frecuente que casi no puedes comer o tomar líquidos?", yes:3, no:0 },
  { id:"Q11", text:"¿Tienes alguna enfermedad crónica importante (corazón, pulmones, riñón, diabetes, cáncer, VIH u otra inmunosupresión)?", yes:3, no:0 },
  { id:"Q12", text:"¿Te han dicho que tienes obesidad o sobrepeso importante?", yes:2, no:0 }
];

// Máximo de puntos de LAS PREGUNTAS (no incluye sensores)
const MAX_SCORE = QUESTIONS.reduce((s,q)=>s + Math.max(q.yes, q.no), 0);

// Mismo mapeo de etiqueta por severidad
function sevLabel(s){
  return s==="high" ? "Crítico alto"
       : s==="mid"  ? "Crítico medio"
       : s==="low"  ? "Crítico bajo"
       :              "No crítico";
}
// Calcula los puntos de sensores (T, SpO2, HR, IMC, edad)
function scoreVitals(vitals, ageYears, heightCm){
  let score = 0;
  let emergency = false;

  const T   = Number.isFinite(vitals.To)    ? vitals.To   : null;
  const spo = Number.isFinite(vitals.spo2)  ? vitals.spo2 : null;
  const hr  = Number.isFinite(vitals.hr)    ? vitals.hr   : null;
  const w   = Number.isFinite(vitals.weight)? vitals.weight : null;

  let bmi = null;
  if (Number.isFinite(w) && Number.isFinite(heightCm) && heightCm > 0){
    const h = heightCm / 100;
    bmi = w / (h*h);
  }

  // Temperatura
  if (T !== null){
    if (T >= 35.5 && T <= 37.4) score += 0;
    else if (T >= 37.5 && T <= 37.9) score += 1;
    else if (T >= 38.0 && T <= 38.9) score += 2;
    else if (T >= 39.0 && T <= 39.9) score += 3;
    else if (T >= 40.0 || T <= 35.4){
      score += 4;
      if (T >= 40.0) emergency = true; // fiebre muy alta
    }
  }

  // SpO2
  if (spo !== null){
    if (spo >= 96) score += 0;
    else if (spo >= 94) score += 2;
    else if (spo >= 92) score += 4;
    else {
      score += 6;
      emergency = true;           // hipoxia importante
    }
  }

  // Frecuencia cardiaca
  if (hr !== null){
    if (hr >= 60 && hr <= 99) score += 0;
    else if (hr >= 100 && hr <= 119) score += 1;
    else if (hr >= 120 && hr <= 139) score += 3;
    else if (hr >= 140) score += 4;
    else if (hr < 50) score += 3;
  }

  // Edad
  if (Number.isFinite(ageYears)){
    if (ageYears >= 65) score += 2;
    else if (ageYears >= 40) score += 1;
  }

  // IMC
  if (bmi !== null){
    if (bmi >= 30 || bmi < 18) score += 2;
  }

  return { sensorsScore: score, bmi, emergencyFromVitals: emergency };
}

// Combina sensores + preguntas y asigna nivel
function computeSeverity(vitals, questionScore, emergencyFromQuestions, ageYears, heightCm){
  const { sensorsScore, bmi, emergencyFromVitals } = scoreVitals(vitals, ageYears, heightCm);
  const total = sensorsScore + questionScore;
  const emergency = emergencyFromVitals || emergencyFromQuestions;

  let sev;
  if (emergency){
    sev = "high"; // ROJO automático
  } else if (total >= 13){
    sev = "high";
  } else if (total >= 9){
    sev = "mid";
  } else if (total >= 5){
    sev = "low";
  } else {
    sev = "ok";
  }

  return {
    total,
    sensorsScore,
    bmi,
    severity: sev,
    severityLabel: sevLabel(sev),
    emergency
  };
}
function nowISO(){ return new Date().toISOString(); }

/*** ESTADO/UI ***/
const el = id=>document.getElementById(id);
const sections = {
  setup:el("setup"), prepHR:el("prepHR"), capHR:el("capHR"),
  prepT:el("prepT"), capT:el("capT"),
  prepW:el("prepW"), capW:el("capW"),
  quiz:el("quiz"), done:el("done")
};
function show(id){ for(const k in sections){ sections[k].style.display = (k===id)?"block":"none"; } }
document.getElementById('wsurl').textContent = WS_URL;

let ws, wsOpen=false;
let patient="", operator="";
let age = null, heightCm = null;
let idx=0, answers=[];
let vitals = { hr:null, spo2:null, To:null, Ta:null, weight:null};

// setup | prep_hr | cap_hr | prep_t | cap_t | quiz | done
let phase = "setup";

function setDot(ok){ const d=el('dot'); d.classList.toggle('ok',ok); d.classList.toggle('bad',!ok); }
function wsConnect(){
  ws = new WebSocket(WS_URL);
  ws.onopen = ()=>{ wsOpen=true; setDot(true); };
  ws.onclose= ()=>{ wsOpen=false; setDot(false); setTimeout(wsConnect, 1500); };
  ws.onerror= ()=>{ wsOpen=false; setDot(false); };
  ws.onmessage = (ev)=>{
    try{
      const msg = JSON.parse(ev.data);
      if(msg?.type === "vitals") onVitals(msg);
    }catch(_){}
  };
}

/*** CAPTURA ***/
let capMode = null;               // "hr" | "temp" | "weight"
let hrVals=[], spoVals=[], toVals=[], taVals=[], wVals=[];

function median(arr){
  const a = arr.slice().sort((x,y)=>x-y);
  const n = a.length;
  if (!n) return null;
  return (n % 2) ? a[(n-1)/2] : (a[n/2 - 1] + a[n/2]) / 2;
}
function avg(arr){
  if (!arr || !arr.length) return null;
  return arr.reduce((s,x)=>s + x, 0) / arr.length;
}
function stddev(arr){
  if (!arr || arr.length < 2) return 0;
  const m = avg(arr);
  const v = arr.reduce((s,x)=>s + (x-m)*(x-m), 0) / (arr.length-1);
  return Math.sqrt(v);
}


function onVitals(msg){
  const v = msg.vitals || {};

  // Peso llega SIEMPRE por WS; sólo colecciona durante la ventana de peso
  if (capMode === "weight" && isFinite(v.weight_kg)) {
    const w = Number(v.weight_kg);
    wVals.push(w);
    el("wNow").textContent = w.toFixed(1);
    el("wCount").textContent = `Muestras: ${wVals.length}`;
  }

  if(capMode === "hr"){
    if(isFinite(v.hr))  el("hrNow").textContent  = Number(v.hr).toFixed(0);
    if(isFinite(v.spo2))el("spoNow").textContent = Number(v.spo2).toFixed(0);
    if(v.hrValid && isFinite(v.hr))     hrVals.push(Number(v.hr));
    if(v.spo2Valid && isFinite(v.spo2)) spoVals.push(Number(v.spo2));
    el("hrCount").textContent = `Muestras válidas: HR=${hrVals.length} | SpO₂=${spoVals.length}`;
  } else if(capMode === "temp"){
    if(isFinite(v.To)) { toVals.push(Number(v.To)); el("toNow").textContent = Number(v.To).toFixed(1); }
    if(isFinite(v.Ta)) { taVals.push(Number(v.Ta)); el("taNow").textContent = Number(v.Ta).toFixed(1); }
    el("tCount").textContent = `Muestras: ${toVals.length}`;
  }
}

/* Preparación y captura con progress */
function runProgress(ms, progEl, secEl, onEnd){
  const t0 = Date.now();
  const tick = ()=>{
    const elapsed = Date.now()-t0;
    const p = Math.min(100, Math.round(elapsed/ms*100));
    progEl.value = p;
    if(secEl){
      const remain = Math.max(0, Math.ceil((ms-elapsed)/1000));
      secEl.textContent = remain;
    }
    if(elapsed < ms) requestAnimationFrame(tick); else onEnd();
  };
  requestAnimationFrame(tick);
}

/*** HR ***/
function startPrepHR(){
  phase = "prep_hr";
  show("prepHR");
  runProgress(PREP_HR_MS, el("prepProgHR"), el("prepSecHR"), startCapHR);
}

function startCapHR(){
  phase = "cap_hr";
  capMode = "hr"; 
  hrVals = []; 
  spoVals = [];
  el("hrNow").textContent  = "--";
  el("spoNow").textContent = "--";
  el("hrCount").textContent = "Muestras válidas: 0";
  show("capHR");
  runProgress(CAP_HR_MS, el("progHR"), null, finishCapHR);
}

function finishCapHR(){
  if (phase !== "cap_hr") return;

  const ok = (hrVals.length >= MIN_HR_OK_SAMPLES) && (spoVals.length >= MIN_SPO_OK_SAMPLES);
  if(!ok){
    if(confirm("No se obtuvieron suficientes muestras del oxímetro.\n¿Deseas continuar sin HR/SpO₂?")){
      vitals.hr   = hrVals.length  ? median(hrVals)  : null;
      vitals.spo2 = spoVals.length ? median(spoVals) : null;
      phase = "prep_t";
      return startPrepTemp();
    } else {
      return startPrepHR();
    }
  }
  vitals.hr   = median(hrVals);
  vitals.spo2 = median(spoVals);
  phase = "prep_t";
  startPrepTemp();
}

/*** Temperatura ***/
function startPrepTemp(){
  phase = "prep_t";
  show("prepT");
  runProgress(PREP_T_MS, el("prepProgT"), el("prepSecT"), startCapTemp);
}

function startCapTemp(){
  phase = "cap_t";
  capMode = "temp"; 
  toVals=[]; 
  taVals=[];
  el("toNow").textContent="--"; 
  el("taNow").textContent="--"; 
  el("tCount").textContent="Muestras: 0";
  show("capT");
  runProgress(CAP_T_MS, el("progT"), null, finishCapTemp);
}


function finishCapTemp(){
  if (phase !== "cap_t") return;

  const ok = (toVals.length >= MIN_T_SAMPLES);
  if(!ok){
    if(confirm("No se obtuvieron suficientes muestras de temperatura.\n¿Deseas continuar sin temperatura?")){
      vitals.To = toVals.length ? avg(toVals) : null;
      vitals.Ta = taVals.length ? avg(taVals) : null;
      // → ir a Peso
      phase = "prep_w";
      return startPrepWeight();
    } else {
      return startPrepTemp();
    }
  }
  vitals.To = avg(toVals);
  vitals.Ta = avg(taVals);

  // ir a Peso
  phase = "prep_w";
  startPrepWeight();
}

function startPrepWeight(){
  phase = "prep_w";
  show("prepW");
  runProgress(PREP_W_MS, el("prepProgW"), el("prepSecW"), startCapWeight);
}

function startCapWeight(){
  phase = "cap_w";
  capMode = "weight";
  wVals = [];
  el("wNow").textContent = "--";
  el("wCount").textContent = "Muestras: 0";
  show("capW");
  runProgress(CAP_W_MS, el("progW"), null, finishCapWeight);
}

function finishCapWeight(){
  if (phase !== "cap_w") return;

  const enough = (wVals.length >= MIN_W_SAMPLES);
  let chosen = null;

  if (enough){
    // Si std > umbral, usa mediana; si no, promedio
    const s = stddev(wVals);
    chosen = (s > MAX_W_STD) ? median(wVals) : avg(wVals);
  }

  if(!enough){
    if(confirm("No se obtuvieron suficientes muestras de peso.\n¿Deseas continuar sin peso?")){
      vitals.weight = null;
      phase = "quiz";
      idx=0; answers = new Array(QUESTIONS.length);
      renderQ(); show("quiz");
      return;
    } else {
      return startPrepWeight();
    }
  }

  vitals.weight = Number(chosen.toFixed(1));
  phase = "quiz";
  idx=0; answers = new Array(QUESTIONS.length);
  renderQ(); show("quiz");
}


/*** CUESTIONARIO ***/
function renderQ(){ 
  const q=QUESTIONS[idx]; 
  el("qtext").textContent=q.text; 
  el("progress").textContent=`Pregunta ${idx+1}/${QUESTIONS.length}`; 
}
function pushAns(ans){
  const q=QUESTIONS[idx];
  answers[idx] = {
  id:      q.id,
  answer:  ans ? "Si" : "No",
  points:  ans ? q.yes : q.no,
  emergency: ans && q.emergencyIfYes === true
};
  idx++;
  if(idx<QUESTIONS.length) renderQ(); else finishAll();
}

/*** ENVÍO ***/
function finishAll(){
  // 1) Resumen preguntas
  const qSummary = (answers || []).reduce((acc, a) => {
    if (!a) return acc;
    const pts = (typeof a.points === "number") ? a.points : 0;
    acc.questionScore += pts;
    if (a.emergency === true) acc.emergencyFromQuestions = true;
    return acc;
  }, { questionScore:0, emergencyFromQuestions:false });

  // 2) Severidad
  const sevData = computeSeverity(
    vitals,
    qSummary.questionScore,
    qSummary.emergencyFromQuestions,
    age,
    heightCm
  );

  // 2.5) Generar ID corto para este registro
  const shareId = makeShareId();

  // 3) Payload para Node-RED
  const payload = {
    type: "submit",
    share_id: shareId,
    patient_name: patient,
    operator: operator || undefined,
    timestamp: nowISO(),

    age_years: Number.isFinite(age) ? age : null,
    height_cm: Number.isFinite(heightCm) ? Number(heightCm.toFixed(1)) : null,
    bmi: Number.isFinite(sevData.bmi) ? Number(sevData.bmi.toFixed(1)) : null,

    answers,
    question_score: qSummary.questionScore,
    sensor_score: sevData.sensorsScore,
    total_score: sevData.total,
    max_score: MAX_SCORE,
    severity: sevData.severity,
    severity_label: sevData.severityLabel,

    vitals: {
      hr_bpm:    Number.isFinite(vitals.hr)    ? Math.round(vitals.hr)        : null,
      spo2_pct:  Number.isFinite(vitals.spo2)  ? Math.round(vitals.spo2)      : null,
      To:        Number.isFinite(vitals.To)    ? Number(vitals.To.toFixed(1)) : null,
      Ta:        Number.isFinite(vitals.Ta)    ? Number(vitals.Ta.toFixed(1)) : null,
      weight_kg: Number.isFinite(vitals.weight)? Number(vitals.weight.toFixed(1)) : null,
      bmi:       Number.isFinite(sevData.bmi)  ? Number(sevData.bmi.toFixed(1)) : null
    }
  };

  // 4) Enviar por WebSocket a Node-RED
  if (wsOpen) {
    try { 
      ws.send(JSON.stringify(payload)); 
      el('raw').textContent = 'Enviado a Node-RED (WS)'; 
    }
    catch(e){ 
      console.error(e); 
      el('raw').textContent = 'No se pudo enviar (WS)'; 
    }
  } else {
    el('raw').textContent = 'Desconectado (WS)';
  }

  // 5) Resumen en pantalla
  const txt = `${patient}: total ${sevData.total} (preguntas: ${qSummary.questionScore}, ` +
              `sensores: ${sevData.sensorsScore}) → ${sevData.severityLabel}`;
  el("resultText").textContent = txt;

  const pill = el("sevPill");
  pill.textContent = sevData.severityLabel;
  pill.className = "pill " + (
    sevData.severity==="high" ? "sev-high" :
    sevData.severity==="mid"  ? "sev-mid"  :
    sevData.severity==="low"  ? "sev-low"  : "sev-ok"
  );

  // 6) URL para compartir
  const shareURL = makeShareURL(shareId);
  renderQR(shareURL);

  // 7) Mostrar pantalla final
  phase = "done";
  show("done");
}



/*** UI events ***/
el("goCapture").onclick = ()=>{
  patient  = el("patient").value.trim();
  operator = el("operator").value.trim();
  age      = parseInt(el("age").value, 10);
  heightCm = parseFloat(el("height").value);

  if(!patient){
    el("patient").focus(); 
    return;
  }

  if (!Number.isFinite(age) || !Number.isFinite(heightCm)){
    alert("Por favor, ingresa edad y estatura.");
    return;
  }

  phase = "prep_hr";
  startPrepHR();
};


el("btnYes").onclick = ()=> pushAns(true);
el("btnNo").onclick  = ()=> pushAns(false);
el("back").onclick   = ()=>{ if(idx>0){ idx--; renderQ(); } };
el("skip").onclick   = ()=> pushAns(false);

el("cancel").onclick = ()=>{
  phase = "setup";
  vitals = { hr:null, spo2:null, To:null, Ta:null, weight:null };
  age = null; heightCm = null;
  show("setup");
};

el("new").onclick    = ()=> {
  patient=""; 
  operator=""; 
  age=null; heightCm=null;
  vitals={hr:null,spo2:null,To:null,Ta:null,weight:null};
  el("patient").value=""; 
  el("operator").value="";
  el("age").value="";
  el("height").value="";
  phase = "setup";
  show("setup");
};


el("retryHR").onclick = startPrepHR;
el("retryT").onclick  = startPrepTemp;
el("retryW").onclick = startPrepWeight;

el("skipHR").onclick  = ()=>{
  // Omitir HR y pasar a temperatura
  vitals.hr=null; 
  vitals.spo2=null; 
  phase = "prep_t";
  startPrepTemp();
};

el("skipT").onclick = ()=>{
  vitals.To = null;
  vitals.Ta = null;
  phase = "prep_w";
  startPrepWeight();     // en vez de ir a 'quiz'
};


el("skipW").onclick  = ()=>{
  vitals.weight = null;
  phase = "quiz";
  idx=0; answers=new Array(QUESTIONS.length);
  renderQ(); show("quiz");
};

wsConnect();
show("setup");

// ===== Helpers para compartir (ID corto + URL corta) =====

// Genera un ID cortito tipo "A3F9XZ"
function makeShareId(){
  return Math.random().toString(36).slice(2, 8).toUpperCase();
}

// Construye la URL de share.html en la misma carpeta que kiosk.html
// Ej: http://10.30.99.110:1880/share.html?id=ABC123
function makeShareURL(id){
  const basePath = location.pathname.replace(/[^/]+$/,'');  // carpeta actual
  const base = `${location.protocol}//${location.host}${basePath}`;
  return `${base}share.html?id=${encodeURIComponent(id)}`;
}
// Render de QR usando la librería qrcode.min.js (new QRCode)
function renderQR(url){
  const box  = document.getElementById('qrCanvas'); // contenedor
  const link = document.getElementById('shareLink');
  link.value = url;

  if (!box) {
    console.error('No se encontró #qrCanvas');
    return;
  }

  // Limpia cualquier QR previo
  box.innerHTML = '';

  // Verificar que la librería esté cargada
  if (typeof QRCode === 'undefined') {
    console.error('Librería QRCode no cargada');
    box.textContent = 'Sin librería QR';
    return;
  }

  // Generar el QR dentro del contenedor
  new QRCode(box, {
    text: String(url),
    width: 320,
    height: 320,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.L
  });


  // Botones de copiar y descargar (fallo en copy, ambas próximas a arreglo o eliminación)
  document.getElementById('copyLink').onclick = async ()=>{
    try {
      await navigator.clipboard.writeText(url);
      alert('Enlace copiado');
    } catch(_){
      alert('No se pudo copiar el enlace');
    }
  };

  document.getElementById('downloadPNG').onclick = ()=>{
    const innerCanvas = box.querySelector('canvas');
    if (!innerCanvas) {
      alert('No se pudo encontrar el canvas del QR');
      return;
    }
    const href = innerCanvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.download = 'pretriage_qr.png';
    a.href = href;
    a.click();
  };
}


</script>
</body>
</html>

